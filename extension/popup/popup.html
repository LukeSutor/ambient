<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="popup.css">
    <title>Chrome Addon v3: popup</title>
</head>
<body>
    <div id="status" style="font-weight:bold;margin-bottom:0.5rem;">Checking connection...</div>
    <button id="refresh-status" style="margin-bottom:0.5rem;">Check Now</button>
    This is the <span class="special-text">HTML</span> body of the addon.
    <script>
    function generateRequestId() {
        return 'req_' + Math.random().toString(36).substr(2, 9);
    }

    async function updateStatus() {
        const requestId = generateRequestId();
        console.log('Sending ping with requestId:', requestId);
        const statusDiv = document.getElementById('status');
        return new Promise((resolve) => {
            // Query the active tab in the current window
            chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
                if (!tabs || !tabs[0] || !tabs[0].id) {
                    statusDiv.textContent = 'No active tab';
                    statusDiv.className = 'disconnected';
                    resolve(false);
                    return;
                }
                chrome.tabs.sendMessage(
                    tabs[0].id,
                    { type: 'ping-tauri', requestId },
                    function(response) {
                        if (chrome.runtime.lastError) {
                            statusDiv.textContent = 'No response from foreground script';
                            statusDiv.className = 'disconnected';
                            resolve(false);
                            return;
                        }
                        if (response && response.type === 'ping-tauri-result' && response.requestId === requestId) {
                            if (response.connected) {
                                statusDiv.textContent = 'Connected';
                                statusDiv.className = 'connected';
                            } else {
                                statusDiv.textContent = 'Disconnected';
                                statusDiv.className = 'disconnected';
                            }
                            if (response.error) {
                                statusDiv.textContent += ' (Error: ' + response.error + ')';
                            }
                            resolve(response.connected);
                        } else {
                            statusDiv.textContent = 'No response from foreground script';
                            statusDiv.className = 'disconnected';
                            resolve(false);
                        }
                    }
                );
            });
        });
    }
    updateStatus();
    setInterval(updateStatus, 2000);

    document.getElementById('refresh-status').addEventListener('click', function() {
        updateStatus();
    });
    </script>
</body>
</html>